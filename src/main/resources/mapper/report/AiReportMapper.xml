<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.project.api.v1.report.mapper.AiReportMapper">

	<select id="selectMonthlyCategoryStats"
	        resultType="com.ssafy.project.api.v1.report.dto.CategoryStats">
	
	  SELECT
	      t.category_id AS categoryId,
	      c.name        AS categoryName,
	
	      COALESCE(SUM(t.amount), 0) AS totalSpend,
	
	      COALESCE(
	        SUM(CASE WHEN t.impulse_flag = 1 THEN t.amount ELSE 0 END),
	        0
	      ) AS impulseSpend
	
	  FROM transactions t
	  LEFT JOIN categories c
	    ON c.category_id = t.category_id
	
	  WHERE t.user_id = #{userId}
	    AND t.tx_type = 'EXPENSE'
	    AND t.occurred_at >= #{startAt}
	    AND t.occurred_at &lt;  #{endAt}
	
	    AND t.is_refund = 0
	    AND t.canceled_at IS NULL
	    AND t.deleted_at IS NULL
	
	  GROUP BY t.category_id, c.name
	  ORDER BY totalSpend DESC
	
	</select>


</mapper>
